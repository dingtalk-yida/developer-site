patch-2

---
title: 如何实现远程数据源分组查询统计？
order: 3
---

# 如何实现远程数据源分组查询统计？

## 使用场景

- 场景1：自定义页面或者表单需要获取并展示分组数据。
- 场景2：觉得官方报表组件满足不了需求，自定义页面引入三方图表组件，实现交互型功能图表。
- 场景3：需要通过官方远程数据源遍历多次后台才得到分组数据。

## 操作步骤（这里用饼图作为示例）
### 步骤 1：新建个报表页,拖入饼图,按自己的需求配置好饼图

<table>
    <tr>
        <td>组件</td> 
        <td>字段</td> 
        <td>配置说明</td> 
        <td>exp</td> 
        <td>最终结果</td> 
   </tr>
    <tr>  
  		  <td>饼图</td> 
        <td>分类字段</td> 
        <td>供你分组统计的依据</td> 
        <td>月份为分类字段,会统计出所有月份</td> 
        <td rowspan="2">显示某年按月份分组统计的数据</td>   
    </tr>
    <tr>  
  		  <td>筛选组件</td> 
        <td>查询字段</td> 
        <td>对数据进行筛选过滤</td> 
        <td>年份为查询字段,会筛选出某年的数据</td> 
    </tr>
</table>

> ❌该报表和组件配置好后不要随意修改可能造成远程数据获取失败  
- 饼图配置-这里(注意:设置数值字段的排序属性,远程数据源的排序参数才会被配置)

![](https://pic.imgdb.cn/item/624fd49e239250f7c5efcb12.png)
- 筛选组件配置(注意:给查询字段设置默认值,远程数据源的查询参数才会被配置)  

![](https://pic.imgdb.cn/item/624fd41f239250f7c5eeb369.png)

- 浏览器按下F12,打开网络面板,然后点击预览
- 找到getDataAsync接口并查看这个接口所携带的参数 

![](https://pic.imgdb.cn/item/624fad98239250f7c59213c8.png)
### 步骤 2：配置数据源

- 添加post数据源,并将下方代码复制到请求地址中的使用变量里面;
<table>
<td>
`/${window.pageConfig.appType || window.g_config.appKey}/visual/visualizationDataRpc/getDataAsync.json`
</td>
</table> 

![](https://pic.imgdb.cn/item/624fab70239250f7c58c97c1.png)

- 这里讲下网络面板中getDataAsync接口关键参数 
- 参数都可以在报表页面中的网络面板getDataAsync接口中找到
- 你需要改的仅仅是queryContext--查询条件


| 参数      | 类型 | 描述     |
| :---        |    :----:   |          :--- |
| csrf_token     | String       | 不是必须的,因为宜搭自带   |
| prdId   | Number        | 饼图的ID      |
| pageId      | String       | 你新建报表的formUuid   |
| cid   | String        |       |
| dataSetKey     | String       |    |
| queryTimestamp   | Number        | 当前提交时间      |
| queryContext   | JSON        | 查询条件(不是必须),见下方表格      |

- queryContext参数详解 

| 参数      | 类型 | 描述     |
| :---        |    :----:   |          :--- |
| filterValueMap     | object       | 这个参数就是筛选条件,可修改<br>*对应报表筛选组件的查询字段所设置默认值*   |
| orderByList   | Array        | 是否进行排序,可修改为升序ASC或降序DESC<br>*对应报表饼图组件的查询字段所设置默认值*      |  

> 下面开始写完整调用代码,我注释掉了所有不必须的代码

> 如果你在实际调用过程中,提示缺少某个属性,你把网络面板getDataAsync接口中对应的参数添加进去就ok

> 参数基本都是报表页面网络面板中getDataAsync接口所携带的参数


```js
//const tokenDom = document.getElementsByName('_csrf_token');
//const token = tokenDom && tokenDom.length ? (tokenDom[0] || {}).value : '';

// 当页面渲染完毕后马上调用下面的函数
export function didMount() {
  const pm = {
    // _csrf_token_: token,
    // _csrf_token: token,
    // _csrf: token,
    prdId: 1707131,  
    pageId: "REPORT-0X8660B1ESSV3BRZ2HIIF9ZDEQ0X2TT5I4NWKA",
    cid: "node_ocl06br0oc2",
    // cname: "饼图_1",
    // componentClassName: "YoushuPieChart",
    queryContext: JSON.stringify({
      // "aliasList": [],
      "filterValueMap": {
        "filter-97a62455-5c8c-400d-9cd4-ae69f10df54e": ["2022"] //查询条件2021,2022都可以,根据你的而实际需求改
      },
      // "dim2table": true,
       "orderByList": [{
         "orderType": "ASC", //这里可改为升序ASC或降序DESC,对查询结果进行排序
         "alias": "field_l01z2f82" 
       }],
      // "needTotalCount": false,
      // "variableParams": {}
    }),
    dataSetKey: "chartData",
    // limit:'',
    // enabledCache: true,
    // version: 0,
    queryTimestamp:new Date().getTime(),
    // appendTraceId: true,
  }
  this.dataSourceMap["getReportData"].load(pm).then(res => {
    console.log(res); //返回经过作者经过折腾后的成果,琢磨东西就是要不断折腾
  })
}
```
## 效果展示  

> 返回后的数据,自己用ES6数组中的map或者forEach函数稍加处理就可以使用了
> 这个方法应该也算是克隆报表查询功能

![](https://pic.imgdb.cn/item/624fda11239250f7c5fb99fc.png)

master